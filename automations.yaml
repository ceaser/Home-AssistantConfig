################################################################################
# image_processing_scan triggers a Tensorflow scan when motion is detected
################################################################################
- id: image_processing_scan
  alias: 'Image Processing Scan'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.driveway_motion_detected
      from: 'off'
      to: 'on'
  action:
    - service: logbook.log
      data_template:
        name: "Image: "
        message: >-
          Scanning image_processing.tensorflow_{{ trigger.entity_id.split('.')[1].split('_')[0] }} at {{ now().strftime('%Y%m%d_%H%M%S') }}.
    - service: image_processing.scan
      data_template:
        entity_id: "image_processing.tensorflow_{{ trigger.entity_id.split('.')[1].split('_')[0] }}"

################################################################################
# tf_image_processing logs objects found in the image_processing_scan
################################################################################
# - id: tf_image_processing_notification
#   alias: 'TF image processing'
#   initial_state: 'on'
#   trigger:
#     - platform: state
#       entity_id:
#         - image_processing.tensorflow_driveway
#   condition:
#     - condition: template
#       value_template: '{{ trigger.to_state.state |int > 0 }}'
#   action:
#     - service: logbook.log
#       data_template:
#         name: "TF: "
#         message: >-
#           {% for object in state_attr(trigger.entity_id,'matches').keys() -%}{%- if loop.first %}{% elif loop.last %}, {% else %}, {% endif -%}{{ object|title }}{%- endfor %} detected in {{ trigger.entity_id.split('.')[1].split('_')[1] }}.

################################################################################
# record_object_detected records video of the object detected from
# image_processing_scan
################################################################################
- id: 'record_object_detected'
  alias: Record object detected
  initial_state: 'off'
  trigger:
  - platform: state
    entity_id:
      - image_processing.tensorflow_driveway
  condition:
  - condition: template
    value_template: '{{ trigger.to_state.state |int > 0 }}'
  - condition: template
    value_template: >
      {%- if states.automation.record_object_detected.attributes.last_triggered -%}
        {{ (as_timestamp(now()) - as_timestamp(states.automation.record_object_detected.attributes.last_triggered)) > 60 }}
      {%- else -%}
        true
      {%- endif -%}
  action:
  - service: logbook.log
    data_template:
      name: "Record: "
      message: >-
        {% for object in state_attr(trigger.entity_id,'matches').keys() -%}{%- if loop.first %}{% elif loop.last %}, {% else %}, {% endif -%}{{ object|title }}{%- endfor %} detected in {{ trigger.entity_id.split('.')[1].split('_')[1] }}. Saving to /local/{{ trigger.entity_id.split('.')[1].split('_')[1] }}_{{ now().strftime('%Y%m%d_%H%M%S') }}.mp4
  - service: camera.record
    data_template:
      duration: 30
      entity_id: camera.{{ trigger.entity_id.split('.')[1].split('_')[1] }}
      filename: /home/homeassistant/.homeassistant/www/{{ trigger.entity_id.split('.')[1].split('_')[1] }}_{{ now().strftime('%Y%m%d_%H%M%S') }}.mp4
      lookback: 30
  - service: logbook.log
    data_template:
      name: "Record Finished: "
      message: >-
        Finished recording {% for object in state_attr(trigger.entity_id,'matches').keys() -%}{%- if loop.first %}{% elif loop.last %}, {% else %}, {% endif -%}{{ object|title }}{%- endfor %} detected in {{ trigger.entity_id.split('.')[1].split('_')[1] }}. Saving to /local/{{ trigger.entity_id.split('.')[1].split('_')[1] }}_{{ now().strftime('%Y%m%d_%H%M%S') }}.mp4
  - service: camera.record

################################################################################
# notify_camera_videos sends a notification when a new video is created
################################################################################
- id: notify_camera_videos
  alias: 'Notify camera videos'
  initial_state: 'off'
  trigger:
  - platform: event
    event_type: folder_watcher
    event_data:
      event_type: created
  condition: []
  action:
  - service: notify.motiondetectgroup
    data_template:
      title: 'Camera recording'
      message: 'Motion detected'
      data:
        attachment:
          hide-thumbnail: false
          url: /local/{{ trigger.event.data.file
            }}
        subtitle: Swipe left to view
        thread-id: motion-detected

################################################################################
# notify_*_camera_pictures sends a picture of the object detected in the
# image_processing_scan. If has conditions for a specific input_boolean and
# notify device
################################################################################
- id: notify_ceaser_camera_pictures
  alias: 'Notify Ceaser camera pictures'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
      - image_processing.tensorflow_driveway
  condition:
    - condition: state
      entity_id: input_boolean.notify_0x4950686f6e65
      state: 'on'
    - condition: template
      value_template: '{{ trigger.to_state.state |int > 0 }}'
    - condition: template
      value_template: >
        {%- if states.automation.notify_ceaser_camera_pictures.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.notify_ceaser_camera_pictures.attributes.last_triggered)) > 30 }}
        {%- else -%}
          true
        {%- endif -%}
  action:
    - service: notify.ios_0x4950686f6e65
      data_template:
        message: >
          {{ state_attr(trigger.entity_id,'matches').keys()|list|unique|list|join(', ')|title }} detected in {{ trigger.entity_id.split('.')[1].split('_')[1] }} camera.
        data:
          push:
            category: 'alarm'
# Stream video
#          entity_id: "camera.{{ trigger.entity_id.split('.')[1].split('_')[1] }}"
          attachment:
            hide-thumbnail: false
# Blank with API link
#            url: >
#              {{ states.camera[trigger.entity_id.split('.')[1].split('_')[1]].attributes.entity_picture }}
            url: "/local/{{ trigger.entity_id.split('.')[1].split('_')[1] }}_latest.jpg"
            content-type: jpg
          subtitle: Swipe left to view

################################################################################
# notify_*_camera_pictures sends a picture of the object detected in the
# image_processing_scan. If has conditions for a specific input_boolean and
# notify device
################################################################################
- id: notify_sarah_camera_pictures
  alias: 'Notify Sarah camera pictures'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
      - image_processing.tensorflow_driveway
  condition:
    - condition: state
      entity_id: input_boolean.notify_iphone
      state: 'on'
    - condition: template
      value_template: '{{ trigger.to_state.state |int > 0 }}'
    - condition: template
      value_template: >
        {%- if states.automation.notify_sarah_camera_pictures.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.notify_sarah_camera_pictures.attributes.last_triggered)) > 30 }}
        {%- else -%}
          true
        {%- endif -%}
  action:
    - service: notify.ios_iphone
      data_template:
        message: >
          {{ state_attr(trigger.entity_id,'matches').keys()|list|unique|list|join(', ')|title }} detected in {{ trigger.entity_id.split('.')[1].split('_')[1] }} camera.
        data:
          push:
            category: 'alarm'
# Stream video
#          entity_id: "camera.{{ trigger.entity_id.split('.')[1].split('_')[1] }}"
          attachment:
            hide-thumbnail: false
# Blank with API link
#            url: >
#              {{ states.camera[trigger.entity_id.split('.')[1].split('_')[1]].attributes.entity_picture }}
            url: "/local/{{ trigger.entity_id.split('.')[1].split('_')[1] }}_latest.jpg"
            content-type: jpg
          subtitle: Swipe left to view

################################################################################
# notify_*_camera_pictures sends a picture of the object detected in the
# image_processing_scan. If has conditions for a specific input_boolean and
# notify device
################################################################################
- id: notify_cearah_camera_pictures
  alias: 'Notify Cearah camera pictures'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
      - image_processing.tensorflow_driveway
  condition:
    - condition: state
      entity_id: input_boolean.notify_cearah_iphone
      state: 'on'
    - condition: template
      value_template: '{{ trigger.to_state.state |int > 0 }}'
    - condition: template
      value_template: >
        {%- if states.automation.notify_cearah_camera_pictures.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.notify_cearah_camera_pictures.attributes.last_triggered)) > 30 }}
        {%- else -%}
          true
        {%- endif -%}
  action:
    - service: notify.ios_cearah_iphone
      data_template:
        message: >
          {{ state_attr(trigger.entity_id,'matches').keys()|list|unique|list|join(', ')|title }} detected in {{ trigger.entity_id.split('.')[1].split('_')[1] }} camera.
        data:
          push:
            category: 'alarm'
# Stream video
#          entity_id: "camera.{{ trigger.entity_id.split('.')[1].split('_')[1] }}"
          attachment:
            hide-thumbnail: false
# Blank with API link
#            url: >
#              {{ states.camera[trigger.entity_id.split('.')[1].split('_')[1]].attributes.entity_picture }}
            url: "/local/{{ trigger.entity_id.split('.')[1].split('_')[1] }}_latest.jpg"
            content-type: jpg
          subtitle: Swipe left to view

################################################################################
# silent_notification disabled a person's notification. This automation is a
# call back from the notify_*_camera_pictures.
################################################################################
- id: silent_notification
  alias: 'Silent Notifications'
  initial_state: 'on'
  trigger:
    - platform: event
      event_type: ios.notification_action_fired
      event_data:
        actionName: 'DISABLE_PUSH'
  action:
    - service: logbook.log
      data_template:
        name: "Action: "
        message: >-
          Received {{ trigger.event.data }}
    - service: input_boolean.turn_off
      data_template:
        entity_id: 'input_boolean.notify_{{ trigger.event.data.sourceDeviceID }}'

################################################################################
# notify_alexa sends a announcement to all Amazon Echo when a object is
# detected from the image_processing_scan
################################################################################
- id: notify_alexa
  alias: 'Notify Alexa'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
      - image_processing.tensorflow_driveway
  condition:
    - condition: state
      entity_id: input_boolean.notify_alexa
      state: 'on'
    - condition: template
      value_template: '{{ trigger.to_state.state |int > 0 }}'
    - condition: template
      value_template: >
        {%- if states.automation.notify_alexa.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.notify_alexa.attributes.last_triggered)) > 30 }}
        {%- else -%}
          true
        {%- endif -%}
  action:
    - service: sonos.snapshot
      data:
        entity_id: media_player.sonos_family_room
        with_group: true
    - service: notify.alexa_media
      data_template:
        target:
          - media_player.kitchen
          - media_player.sandra_s_room
        title: >
          "camera.{{ trigger.entity_id.split('.')[1].split('_')[1] }} notification"
        message: >
          Detected a {{ state_attr(trigger.entity_id,'matches').keys()|list|unique|list|join(' and ')|title }} in the {{ trigger.entity_id.split('.')[1].split('_')[1] }} camera.
        data:
          type: announce
          method: speak
    - service: sonos.restore
      data:
        entity_id: media_player.sonos_familyroom
        with_group: true

################################################################################
# climate_away_mode sets the thermostats to eco and away mode when humans are
# away
################################################################################
- id: climate_away_mode
  alias: 'Climate Away Mode'
  initial_state: 'on'
  trigger:
    - platform: zone
      entity_id: person.ceaser
      event: leave
      zone: zone.home
    - platform: zone
      entity_id: person.cearah
      event: leave
      zone: zone.home
    - platform: zone
      entity_id: person.sarah
      event: leave
      zone: zone.home
  condition:
    - condition: state
      entity_id: binary_sensor.hallway_thermostat_online
      state: 'on'
    - condition: template
      value_template: '{{
        states.climate.hallway.attributes.away_mode == "off" and
        states.person.cearah.state != "home" and
        states.person.ceaser.state != "home" and
        states.person.sarah.state != "home"}}'
  action:
    - service: climate.set_preset_mode
      data:
        entity_id: climate.hallway
        preset_mode: 'Away and Eco'

################################################################################
# climate_home_mode sets the thermostats to auto mode when humans are
# home
################################################################################
- id: climate_home_mode
  alias: 'Climate Home Mode'
  initial_state: 'on'
  trigger:
    - platform: zone
      entity_id: person.ceaser
      event: enter
      zone: zone.home
    - platform: zone
      entity_id: person.cearah
      event: enter
      zone: zone.home
    - platform: zone
      entity_id: person.sarah
      event: enter
      zone: zone.home
    - platform: zone
      entity_id: person.ceaser
      event: enter
      zone: zone.east_gate
    - platform: zone
      entity_id: person.cearah
      event: enter
      zone: zone.east_gate
    - platform: zone
      entity_id: person.sarah
      event: enter
      zone: zone.east_gate
  condition:
    - condition: state
      entity_id: binary_sensor.hallway_thermostat_online
      state: 'on'
    - condition: template
      value_template: '{{
        states.climate.hallway.attributes.away_mode == "on" and
        (
          states.person.cearah.state == "home" or
          states.person.ceaser.state == "home" or
          states.person.sarah.state == "home"
        ) }}'
  action:
    - service: climate.set_preset_mode
      data:
        entity_id: climate.hallway
        preset_mode: none

- id: turn_on_fan
  alias: 'Turn on fan'
  initial_state: 'off'
  trigger:
    - platform: numeric_state
      entity_id: sensor.office_temperature
      below: 75
      above: 80
    - platform: numeric_state
      entity_id: sensor.office_temperature
      below: 79
      above: 80
  condition:
    - condition: template
      value_template: >
        {%- if states.automation.turn_on_fan.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.turn_on_fan.attributes.last_triggered)) > 1800 }}
        {%- else -%}
          true
        {%- endif -%}
    - condition: state
      entity_id: sensor.hallway_thermostat_hvac_state
      state: 'off'
    - condition: state
      entity_id: binary_sensor.hallway_thermostat_fan
      state: 'off'
    - condition: state
      entity_id: binary_sensor.hallway_thermostat_online
      state: 'on'
    - condition: template
      value_template: <
        {{ (states.climate.hallway.attributes.target_temp_high | int) - (states.sensor.office_temperature.state |round | int ) > 3 }}
  action:
    - service: climate.set_fan_mode
      data:
        entity_id: climate.hallway
        fan_mode: 'on'

- id: turn_off_fan
  alias: 'Turn off fan'
  initial_state: 'off'
  trigger:
    - platform: numeric_state
      entity_id: sensor.office_temperature
      below: 80
      above: 75
    - platform: numeric_state
      entity_id: sensor.office_temperature
      below: 80
      above: 79
  condition:
    - condition: template
      value_template: >
        {%- if states.automation.turn_off_fan.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.turn_off_fan.attributes.last_triggered)) > 1800 }}
        {%- else -%}
          true
        {%- endif -%}
    - condition: state
      entity_id: sensor.hallway_thermostat_hvac_state
      state: 'off'
    - condition: state
      entity_id: binary_sensor.hallway_thermostat_fan
      state: 'on'
    - condition: state
      entity_id: binary_sensor.hallway_thermostat_online
      state: 'on'
    - condition: template
      value_template: <
        {{ (states.climate.hallway.attributes.target_temp_high | int) - (states.sensor.office_temperature.state |round | int ) <= 3 }}
  action:
    - service: climate.set_fan_mode
      data:
        entity_id: climate.hallway
        fan_mode: 'off'


################################################################################
# notify_vitara sends an alert where I last parted the second car when I get
# on the train.
################################################################################
- id: notify_vitara
  alias: 'Notify Vitara location'
  initial_state: 'on'
  trigger:
    - platform: zone
      entity_id: person.ceaser
      event: enter
      zone: zone.roy_station
  condition:
    - condition: and
      conditions:
      - condition: state
        entity_id: binary_sensor.workday_sensor
        state: 'on'
      - before: '19:00:00'
        condition: time
  action:
    - service: notify.ios_0x4950686f6e65
      data:
        message: The Vitara is parked at the {{ states("device_tracker.tile_969f352152684c55")
          }}

################################################################################
# alexa_morning_volume_kitcheni raise the volume of the echo to 60%
################################################################################
- id: alexa_morning_volume_kitchen
  alias: 'Alexa Volume [Morning]: Kitchen'
  trigger:
  - platform: time
    at: '06:30:00'
  action:
  - service: media_player.volume_set
    data:
      entity_id: media_player.kitchen
      volume_level: '0.60'

################################################################################
# alexa_morning_volume_kitcheni reduces the volume of the echo to 20%
################################################################################
- id: alexa_night_volume_kitchen
  alias: 'Alexa Volume [Night]: Kitchen'
  trigger:
  - platform: time
    at: '22:00:00'
  action:
  - service: media_player.volume_set
    data:
      entity_id: media_player.kitchen
      volume_level: '0.20'

################################################################################
# capture_cleaning_map updates the vacuums cleaning map
################################################################################
- id: capture_cleaning_map
  alias: 'Update Cleaning Map'
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id:
      - vacuum.basement
      - vacuum.upstairs
    from: 'cleaning'
    to: 'docked'
  condition: []
  action:
  - service: camera.snapshot
    data_template:
      entity_id: "camera.{{ trigger.entity_id.split('.')[1].split('_')[0] }}_cleaning_map"
      filename: "/home/homeassistant/.homeassistant/www/{{ trigger.entity_id.split('.')[1].split('_')[0] }}_cleaning_map_latest.jpg"

################################################################################
# network_away_mode resume all network services that consume large amount of
# bandwidth
################################################################################
- id: network_away_mode
  alias: 'Network Away Mode'
  initial_state: 'on'
  trigger:
    - platform: zone
      entity_id: person.cearah
      event: leave
      zone: zone.home
    - platform: zone
      entity_id: person.sarah
      event: leave
      zone: zone.home
    - platform: time
      at: '00:00:00'
  condition:
    condition: or
    conditions:
      - condition: template
        value_template: '{{
          states.person.cearah.state != "home" and
          states.person.sarah.state != "home"}}'
      - condition: time
        before: '08:00:00'
  action:
    - service: rest_command.nzbget
      data:
        method: resumedownload
    - service: rest_command.aria2
      data:
        method: aria2.unpauseAll
        token: !secret aria2_token
    - service: shell_command.deluge_resume

################################################################################
# network_home_mode pauses all network services that consume large amount of
# bandwidth
################################################################################
- id: network_home_mode
  alias: 'Network Home Mode'
  initial_state: 'off'
  trigger:
    - platform: zone
      entity_id: person.cearah
      event: enter
      zone: zone.home
    - platform: zone
      entity_id: person.sarah
      event: enter
      zone: zone.home
  condition:
    condition: or
    conditions:
      - condition: template
        value_template: '{{
          states.person.cearah.state == "home" or
          states.person.sarah.state == "home"}}'
      - condition: time
        after: '08:00:00'
  action:
    - service: rest_command.nzbget
      data:
        method: pausedownload
    - service: rest_command.aria2
      data:
        method: aria2.pauseAll
        token: !secret aria2_token
    - service: shell_command.deluge_pause

################################################################################
# Sonos
################################################################################
- id: sonos_default_volume
  alias: 'Sonos Default Volume'
  trigger:
    - platform: state
      entity_id: media_player.sonos_familyroom
      from: playing
      to: paused
      for:
        minutes: 15
  action:
    - service: media_player.volume_set
      data:
        entity_id: media_player.sonos_familyroom
        volume_level: 0.2

- id: sonos_get
  alias: 'Sonos Get'
  initial_state: 'on'
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: media_player.sonos_familyroom
  action:
    - service_template: "homeassistant.turn_{{ 'on' if is_state_attr('media_player.sonos_familyroom', 'speech_enhance', true) else 'off' }}"
      data:
        entity_id: input_boolean.sonos_familyroom_speech_enhance
    - service_template: "homeassistant.turn_{{ 'on' if is_state_attr('media_player.sonos_familyroom', 'night_sound', true) else 'off' }}"
      data:
        entity_id: input_boolean.sonos_familyroom_night_sound
    - service: "input_select.select_option"
      data_template:
        entity_id: input_select.sonos_familyroom_source
        option: "{{ 'TV' if is_state_attr('media_player.sonos_familyroom', 'source', 'TV') else 'None' }}"

- id: sonos_set
  alias: 'Sonos Set'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
        - input_boolean.sonos_familyroom_night_sound
        - input_boolean.sonos_familyroom_speech_enhance
  condition:
    - condition: template
      value_template: >
        {%- if states.automation.sonos_set.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.sonos_set.attributes.last_triggered)) > 2 }}
        {%- else -%}
          true
        {%- endif -%}
    - condition: template
      value_template: '{{
        ( is_state_attr("media_player.sonos_familyroom", "night_sound", true) != is_state("input_boolean.sonos_familyroom_night_sound", "on")) or
        ( is_state_attr("media_player.sonos_familyroom", "speech_enhance", true) != is_state("input_boolean.sonos_familyroom_speech_enhance", "on")) }}'
  action:
    - delay: 00:00:01
    - service: sonos.set_option
      data_template:
        entity_id: "media_player.sonos_familyroom"
        night_sound: >
          {{ states('input_boolean.sonos_familyroom_night_sound') == "on" }}
        speech_enhance: >
          {{ states('input_boolean.sonos_familyroom_speech_enhance') == "on" }}

################################################################################
# Printing
################################################################################
- id: notify_when_printer_is_ready
  alias: 'Notify When Printer is Ready'
  initial_state: on
  trigger:
    - platform: numeric_state
      entity_id: sensor.anet_a8_actual_tool0_temp
      above: 374 # 190 C
      for:
        minutes: 5
    - platform: numeric_state
      entity_id: sensor.anet_a8_actual_bed_temp
      above: 104 # 40 C
      for:
        minutes: 5
  condition:
    - condition: template
      value_template: >
        {%- if states.automation.notify_when_printer_is_ready.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.notify_when_printer_is_ready.attributes.last_triggered)) > 60 }}
        {%- else -%}
          true
        {%- endif -%}
    - condition: state
      entity_id: binary_sensor.anet_a8_printing
      state: 'off'
#    - condition: numeric_state
#      entity_id: sensor.anet_a8_actual_bed_temp
#      above: 104
    - condition: numeric_state
      entity_id: sensor.anet_a8_actual_tool0_temp
      above: 374
  action:
    - service: notify.ios_0x4950686f6e65
      data_template:
        message: "Printer is ready"
        data:
          push:
            category: 'printer'

- id: notify_when_printer_is_finished
  alias: 'Notify When Printer is Finished'
  initial_state: on
  trigger:
    - platform: state
      entity_id: binary_sensor.anet_a8_printing
      from: 'on'
      to: 'off'
  action:
    - service: notify.ios_0x4950686f6e65
      data_template:
        message: "Printing is completed"
        data:
          push:
            category: 'printer'
          attachment:
            hide-thumbnail: false
            url: camera.anet_a8.attributes.entity_picture
          subtitle: Swipe left to view

- id: turn_off_power_when_finished_printing
  alias: 'Turn off power when finished printing'
  initial_state: off
  trigger:
    - platform: state
      entity_id: binary_sensor.anet_a8_printing
      from: 'on'
      to: 'off'
      for:
        minutes: 15
  condition:
    - condition: template
      value_template: >
        {%- if states.automation.turn_off_power_when_finished_printing.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.turn_off_power_when_finished_printing.attributes.last_triggered)) > 300 }}
        {%- else -%}
          true
        {%- endif -%}
    - condition: state
      entity_id: binary_sensor.anet_a8_printing
      state: 'off'
  action:
    - service: shell_command.stop_octoprint
    - service: logbook.log
      data_template:
        name: "Printer: "
        message: >-
          Shutdown Octoprint
    - service: switch.turn_off
      data:
        entity_id: switch.storage_room 
    - service: logbook.log
      data_template:
        name: "Printer: "
        message: >-
          Turn off Storage Room Light
    - delay: '00:02:00'
    - service: switch.turn_off
      data:
        entity_id: switch.anet_a8_power_strip
    - service: logbook.log
      data_template:
        name: "Printer: "
        message: >-
          Turn off Anet A8 Power Strip

- id: notify_when_printer_is_operational
  alias: 'Notify When Printer is Operational'
  initial_state: on
  trigger:
    - platform: state
      entity_id: sensor.anet_a8_current_state
      from: 'unknown'
      to: 'Operational'
  action:
    - service: notify.ios_0x4950686f6e65
      data_template:
        message: "Printer Online"
        data:
          push:
            category: 'printer'

################################################################################
# Automower 
################################################################################
- id: 'park_automower'
  alias: Park Automower
  trigger:
    - platform: numeric_state
      entity_id: sensor.dark_sky_precip_probability
      above: 99
  action:
    - service: logbook.log
      data_template:
        name: "Automower: "
        message: >-
          Parking Automower {{ now().strftime('%Y%m%d_%H%M%S') }}.
    - service: vacuum.return_to_base
      data:
        entity_id: vacuum.automower
    - service: notify.ios_0x4950686f6e65
      data_template:
        message: "Automower Parked"
        data:
          push:
            category: 'automower'

- id: 'start_automower'
  alias: Start Automower
  trigger:
    - platform: numeric_state
      entity_id: sensor.dark_sky_precip_probability
      below: 99
  condition:
    - condition: or
      conditions:
      - condition: state
        entity_id: vacuum.automower
        state: Cutting
      - condition: state
        entity_id: vacuum.automower
        state: Cutting (manual timer override)
      - condition: state
        entity_id: vacuum.automower
        state: Leaving base
  action:
    - service: logbook.log
      data_template:
        name: "Automower: "
        message: >-
          Starting Automower {{ now().strftime('%Y%m%d_%H%M%S') }}.
    - service: vacuum.return_to_base
      data:
        entity_id: vacuum.automower
    - service: notify.ios_0x4950686f6e65
      data_template:
        message: "Automower Started"
        data:
          push:
            category: 'automower'

- id: 'park_automower'
  alias: Park Automower
  trigger:
    - platform: numeric_state
      entity_id: sensor.dark_sky_precip_probability
      above: 95
  action:
    - service: logbook.log
      data_template:
        name: "Automower: "
        message: >-
          Parking Automower {{ now().strftime('%Y%m%d_%H%M%S') }}.
    - service: vacuum.return_to_base
      data:
        entity_id: vacuum.automower
    - service: notify.ios_0x4950686f6e65
      data_template:
        message: "Automower Parked"
        data:
          push:
            category: 'automower'

- id: 'pause_automower'
  alias: Pause Automower
  trigger:
    - entity_id: device_tracker.automower_g_191108221_190740383
      event: enter
      platform: zone
      zone: zone.east_gate
    - entity_id: input_boolean.dog_outside
      from: 'off'
      platform: state
      to: 'on'
  condition:
    - condition: or
      conditions:
      - condition: state
        entity_id: vacuum.automower
        state: Cutting
      - condition: state
        entity_id: vacuum.automower
        state: Cutting (manual timer override)
      - condition: state
        entity_id: vacuum.automower
        state: Leaving base
  action:
    - service: logbook.log
      data_template:
        name: "Automower: "
        message: >-
          Pausing Automower {{ now().strftime('%Y%m%d_%H%M%S') }}.
    - service: vacuum.start_pause
      data:
        entity_id: vacuum.automower
    - service: notify.ios_0x4950686f6e65
      data_template:
        message: "Automower Paused"
        data:
          push:
            category: 'automower'

- id: 'resume_automower_after_pause'
  alias: Resume Automower After Pause
  trigger:
    - entity_id: input_boolean.east_gate
      from: 'on'
      platform: state
      to: 'off'
    - entity_id: input_boolean.dog_outside
      from: 'on'
      platform: state
      to: 'off'
  condition:
    - condition: state
      entity_id: vacuum.automower
      state: Paused
  action:
    - service: logbook.log
      data_template:
        name: "Automower: "
        message: >-
          Resuming Automower {{ now().strftime('%Y%m%d_%H%M%S') }}.
    - data:
        entity_id: vacuum.automower
      service: vacuum.start_pause

################################################################################
# RainMachine
################################################################################
- id: 'pause_rainmachine'
  alias: Pause RainMachine
  trigger:
  - entity_id: input_boolean.dog_outside
    from: 'off'
    platform: state
    to: 'on'
  condition: []
  action:
  - data:
      seconds: 300
    service: rainmachine.pause_watering

################################################################################
# Garage
################################################################################
- id: 'turn_on_garage_entry_light'
  alias: Turn on Garage Entry Light
  trigger:
  - entity_id: input_boolean.dog_outside
    from: 'off'
    platform: state
    to: 'on'
  condition:
  - condition: state  # from sunset until sunrise
    entity_id: sun.sun
    state: 'below_horizon'
  action:
  - data:
      entity_id: switch.garage_entry_light
    service: switch.turn_on

- id: 'turn_off_garage_entry_light'
  alias: Turn off Garage Entry Light
  trigger:
  - entity_id: input_boolean.dog_outside
    from: 'on'
    platform: state
    to: 'off'
  condition: []
  action:
  - data:
      entity_id: switch.garage_entry_light
    service: switch.turn_off
