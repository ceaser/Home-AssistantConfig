################################################################################
# image_processing_scan triggers a Tensorflow scan when motion is detected
################################################################################
- id: image_processing_scan
  alias: 'Image Processing Scan'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.driveway_motion_detected
      from: 'off'
      to: 'on'
  action:
    - service: logbook.log
      data_template:
        name: "Image: "
        message: >-
          Scanning image_processing.tensorflow_{{ trigger.entity_id.split('.')[1].split('_')[0] }} at {{ now().strftime('%Y%m%d_%H%M%S') }}.
    - service: image_processing.scan
      data_template:
        entity_id: "image_processing.tensorflow_{{ trigger.entity_id.split('.')[1].split('_')[0] }}"

################################################################################
# tf_image_processing logs objects found in the image_processing_scan
################################################################################
# - id: tf_image_processing_notification
#   alias: 'TF image processing'
#   initial_state: 'on'
#   trigger:
#     - platform: state
#       entity_id:
#         - image_processing.tensorflow_driveway
#   condition:
#     - condition: template
#       value_template: '{{ trigger.to_state.state |int > 0 }}'
#   action:
#     - service: logbook.log
#       data_template:
#         name: "TF: "
#         message: >-
#           {% for object in state_attr(trigger.entity_id,'matches').keys() -%}{%- if loop.first %}{% elif loop.last %}, {% else %}, {% endif -%}{{ object|title }}{%- endfor %} detected in {{ trigger.entity_id.split('.')[1].split('_')[1] }}.

################################################################################
# record_object_detected records video of the object detected from
# image_processing_scan
################################################################################
- id: 'record_object_detected'
  alias: Record object detected
  initial_state: 'off'
  trigger:
  - platform: state
    entity_id:
      - image_processing.tensorflow_driveway
  condition:
  - condition: template
    value_template: '{{ trigger.to_state.state |int > 0 }}'
  - condition: template
    value_template: >
      {%- if states.automation.record_object_detected.attributes.last_triggered -%}
        {{ (as_timestamp(now()) - as_timestamp(states.automation.record_object_detected.attributes.last_triggered)) < 60 }}
      {%- else -%}
        true
      {%- endif -%}
  action:
  - service: logbook.log
    data_template:
      name: "Record: "
      message: >-
        {% for object in state_attr(trigger.entity_id,'matches').keys() -%}{%- if loop.first %}{% elif loop.last %}, {% else %}, {% endif -%}{{ object|title }}{%- endfor %} detected in {{ trigger.entity_id.split('.')[1].split('_')[1] }}. Saving to /local/{{ trigger.entity_id.split('.')[1].split('_')[1] }}_{{ now().strftime('%Y%m%d_%H%M%S') }}.mp4
  - service: camera.record
    data_template:
      duration: 30
      entity_id: camera.{{ trigger.entity_id.split('.')[1].split('_')[1] }}
      filename: /home/homeassistant/.homeassistant/www/{{ trigger.entity_id.split('.')[1].split('_')[1] }}_{{ now().strftime('%Y%m%d_%H%M%S') }}.mp4
      lookback: 30
  - service: logbook.log
    data_template:
      name: "Record Finished: "
      message: >-
        Finished recording {% for object in state_attr(trigger.entity_id,'matches').keys() -%}{%- if loop.first %}{% elif loop.last %}, {% else %}, {% endif -%}{{ object|title }}{%- endfor %} detected in {{ trigger.entity_id.split('.')[1].split('_')[1] }}. Saving to /local/{{ trigger.entity_id.split('.')[1].split('_')[1] }}_{{ now().strftime('%Y%m%d_%H%M%S') }}.mp4
  - service: camera.record

################################################################################
# notify_camera_videos sends a notification when a new video is created 
################################################################################
- id: notify_camera_videos
  alias: 'Notify camera videos'
  initial_state: 'off'
  trigger:
  - platform: event
    event_type: folder_watcher
    event_data:
      event_type: created
  condition: []
  action:
  - service: notify.motiondetectgroup
    data_template:
      title: 'Camera recording'
      message: 'Motion detected'
      data:
        attachment:
          hide-thumbnail: false
          url: /local/{{ trigger.event.data.file
            }}
        subtitle: Swipe left to view
        thread-id: motion-detected

################################################################################
# notify_*_camera_pictures sends a picture of the object detected in the
# image_processing_scan. If has conditions for a specific input_boolean and
# notify device 
################################################################################
- id: notify_ceaser_camera_pictures
  alias: 'Notify Ceaser camera pictures'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
      - image_processing.tensorflow_driveway
  condition:
    - condition: state
      entity_id: input_boolean.notify_0x4950686f6e65
      state: 'on'
    - condition: template
      value_template: '{{ trigger.to_state.state |int > 0 }}'
    - condition: template
      value_template: >
        {%- if states.automation.notify_ceaser_camera_pictures.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.notify_ceaser_camera_pictures.attributes.last_triggered)) > 30 }}
        {%- else -%}
          true
        {%- endif -%}
  action:
    - service: notify.ios_0x4950686f6e65
      data_template:
        message: >
          {{ state_attr(trigger.entity_id,'matches').keys()|list|unique|list|join(', ')|title }} detected in {{ trigger.entity_id.split('.')[1].split('_')[1] }} camera.
        data:
          push:
            category: 'alarm'
# Stream video
#          entity_id: "camera.{{ trigger.entity_id.split('.')[1].split('_')[1] }}"
          attachment:
            hide-thumbnail: false
# Blank with API link
#            url: >
#              {{ states.camera[trigger.entity_id.split('.')[1].split('_')[1]].attributes.entity_picture }}
            url: "/local/{{ trigger.entity_id.split('.')[1].split('_')[1] }}_latest.jpg"
            content-type: jpg
          subtitle: Swipe left to view

################################################################################
# notify_*_camera_pictures sends a picture of the object detected in the
# image_processing_scan. If has conditions for a specific input_boolean and
# notify device 
################################################################################
- id: notify_sarah_camera_pictures
  alias: 'Notify Sarah camera pictures'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
      - image_processing.tensorflow_driveway
  condition:
    - condition: state
      entity_id: input_boolean.notify_iphone
      state: 'on'
    - condition: template
      value_template: '{{ trigger.to_state.state |int > 0 }}'
    - condition: template
      value_template: >
        {%- if states.automation.notify_sarah_camera_pictures.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.notify_sarah_camera_pictures.attributes.last_triggered)) > 30 }}
        {%- else -%}
          true
        {%- endif -%}
  action:
    - service: notify.ios_iphone
      data_template:
        message: >
          {{ state_attr(trigger.entity_id,'matches').keys()|list|unique|list|join(', ')|title }} detected in {{ trigger.entity_id.split('.')[1].split('_')[1] }} camera.
        data:
          push:
            category: 'alarm'
# Stream video
#          entity_id: "camera.{{ trigger.entity_id.split('.')[1].split('_')[1] }}"
          attachment:
            hide-thumbnail: false
# Blank with API link
#            url: >
#              {{ states.camera[trigger.entity_id.split('.')[1].split('_')[1]].attributes.entity_picture }}
            url: "/local/{{ trigger.entity_id.split('.')[1].split('_')[1] }}_latest.jpg"
            content-type: jpg
          subtitle: Swipe left to view

################################################################################
# notify_*_camera_pictures sends a picture of the object detected in the
# image_processing_scan. If has conditions for a specific input_boolean and
# notify device 
################################################################################
- id: notify_cearah_camera_pictures
  alias: 'Notify Cearah camera pictures'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
      - image_processing.tensorflow_driveway
  condition:
    - condition: state
      entity_id: input_boolean.notify_cearah_iphone
      state: 'on'
    - condition: template
      value_template: '{{ trigger.to_state.state |int > 0 }}'
    - condition: template
      value_template: >
        {%- if states.automation.notify_cearah_camera_pictures.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.notify_cearah_camera_pictures.attributes.last_triggered)) > 30 }}
        {%- else -%}
          true
        {%- endif -%}
  action:
    - service: notify.ios_cearah_iphone
      data_template:
        message: >
          {{ state_attr(trigger.entity_id,'matches').keys()|list|unique|list|join(', ')|title }} detected in {{ trigger.entity_id.split('.')[1].split('_')[1] }} camera.
        data:
          push:
            category: 'alarm'
# Stream video
#          entity_id: "camera.{{ trigger.entity_id.split('.')[1].split('_')[1] }}"
          attachment:
            hide-thumbnail: false
# Blank with API link
#            url: >
#              {{ states.camera[trigger.entity_id.split('.')[1].split('_')[1]].attributes.entity_picture }}
            url: "/local/{{ trigger.entity_id.split('.')[1].split('_')[1] }}_latest.jpg"
            content-type: jpg
          subtitle: Swipe left to view

################################################################################
# silent_notification disabled a person's notification. This automation is a
# call back from the notify_*_camera_pictures.
################################################################################
- id: silent_notification
  alias: 'Silent Notifications'
  initial_state: 'on'
  trigger:
    - platform: event
      event_type: ios.notification_action_fired
      event_data:
        actionName: 'DISABLE_PUSH'
  action:
    - service: logbook.log
      data_template:
        name: "Action: "
        message: >-
          Received {{ trigger.event.data }}
    - service: input_boolean.turn_off
      data_template:
        entity_id: 'input_boolean.notify_{{ trigger.event.data.sourceDeviceID }}'

################################################################################
# notify_alexa sends a announcement to all Amazon Echo when a object is
# detected from the image_processing_scan
################################################################################
- id: notify_alexa
  alias: 'Notify Alexa'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
      - image_processing.tensorflow_driveway
  condition:
    - condition: state
      entity_id: input_boolean.notify_alexa
      state: 'on'
    - condition: template
      value_template: '{{ trigger.to_state.state |int > 0 }}'
    - condition: template
      value_template: >
        {%- if states.automation.notify_alexa.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.notify_alexa.attributes.last_triggered)) > 30 }}
        {%- else -%}
          true
        {%- endif -%}
  action:
    - service: media_player.sonos_snapshot
      data:
        entity_id: media_player.sonos_family_room
        with_group: true
    - service: notify.alexa_media
      data_template:
        target:
          - media_player.kitchenecho
          - media_player.ceaser_s_sonos_beam
        title: >
          "camera.{{ trigger.entity_id.split('.')[1].split('_')[1] }} notification" 
        message: >
          Detected a {{ state_attr(trigger.entity_id,'matches').keys()|list|unique|list|join(' and ')|title }} in the {{ trigger.entity_id.split('.')[1].split('_')[1] }} camera.
        data:
          type: announce
          method: speak
    - service: media_player.sonos_restore
      data:
        entity_id: media_player.sonos_family_room
        with_group: true

################################################################################
# climate_away_mode sets the thermostats to eco and away mode when humans are
# away  
################################################################################
- id: climate_away_mode
  alias: 'Climate Away Mode'
  initial_state: 'on'
  trigger:
    - platform: zone
      entity_id: person.ceaser
      event: leave
      zone: zone.home
    - platform: zone
      entity_id: person.cearah
      event: leave
      zone: zone.home
    - platform: zone
      entity_id: person.sarah
      event: leave
      zone: zone.home
  condition:
    - condition: template
      value_template: '{{
        states.climate.hallway.attributes.away_mode == "off" and 
        states.person.cearah.state != "home" and
        states.person.ceaser.state != "home" and
        states.person.sarah.state != "home"}}'
  action:
    - service: climate.set_away_mode
      data:
        entity_id: climate.hallway
        away_mode: true
    - service: climate.set_operation_mode
      data:
        entity_id: climate.hallway
        operation_mode: eco

################################################################################
# climate_home_mode sets the thermostats to auto mode when humans are
# home  
################################################################################
- id: climate_home_mode
  alias: 'Climate Home Mode'
  initial_state: 'on'
  trigger:
    - platform: zone
      entity_id: person.ceaser
      event: enter
      zone: zone.home
    - platform: zone
      entity_id: person.cearah
      event: enter
      zone: zone.home
    - platform: zone
      entity_id: person.sarah
      event: enter
      zone: zone.home
  condition:
    - condition: template
      value_template: '{{
        states.climate.hallway.attributes.away_mode == "on" and
        (
          states.person.cearah.state == "home" or
          states.person.ceaser.state == "home" or
          states.person.sarah.state == "home"
        ) }}'
  action:
    - service: climate.set_away_mode
      data:
        entity_id: climate.hallway
        away_mode: false
    - service: climate.set_operation_mode
      data:
        entity_id: climate.hallway
        operation_mode: auto

################################################################################
# notify_vitara sends an alert where I last parted the second car when I get
# on the train.
################################################################################
- id: notify_vitara
  alias: 'Notify Vitara location'
  initial_state: 'on'
  trigger:
    - platform: zone
      entity_id: person.ceaser
      event: enter
      zone: zone.roy_station
  condition:
    - condition: and
      conditions:
      - condition: state
        entity_id: binary_sensor.workday_sensor
        state: 'on'
      - before: '19:00:00'
        condition: time
  action:
    - service: notify.ios_0x4950686f6e65
      data:
        message: The Vitara is parked at the {{ states("device_tracker.tile_969f352152684c55")
          }}

################################################################################
# alexa_morning_volume_kitcheni raise the volume of the echo to 60%
################################################################################
- id: alexa_morning_volume_kitchen
  alias: 'Alexa Volume [Morning]: Kitchen'
  trigger:
  - platform: time
    at: '06:30:00'
  action:
  - service: media_player.volume_set
    data:
      entity_id: media_player.kitchenecho
      volume_level: '0.60'

################################################################################
# alexa_morning_volume_kitcheni reduces the volume of the echo to 20%
################################################################################
- id: alexa_night_volume_kitchen
  alias: 'Alexa Volume [Night]: Kitchen'
  trigger:
  - platform: time
    at: '22:00:00'
  action:
  - service: media_player.volume_set
    data:
      entity_id: media_player.kitchenecho
      volume_level: '0.20'


################################################################################
# 
################################################################################
- id: alexa_night_volume_family_room
  alias: 'Alexa Volume [Night]: Family Room'
  trigger:
  - platform: time
    at: '00:06:30'
  condition:
    condition: state
    entity_id: media_player.sonos_family_room
    state: 'Paused'
  action:
  - service: media_player.volume_set
    data:
      entity_id: media_player.ceaser_s_sonos_beam
      volume_level: '0.40'

################################################################################
# 
################################################################################
- id: alexa_night_volume_family_room
  alias: 'Alexa Volume [Night]: Family Room'
  trigger:
  - platform: time
    at: '22:00:00'
  - platform: time
    at: '00:00:00'
  - platform: time
    at: '02:00:00'
  condition:
    condition: state
    entity_id: media_player.sonos_family_room
    state: 'Paused'
  action:
  - service: media_player.volume_set
    data:
      entity_id: media_player.ceaser_s_sonos_beam
      volume_level: '0.10'

################################################################################
# capture_cleaning_map updates the vacuums cleaning map 
################################################################################
- id: capture_cleaning_map
  alias: 'Update Cleaning Map'
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id:
      - vacuum.basement
      - vacuum.upstairs
    from: 'cleaning'
    to: 'docked'
  condition: []
  action:
  - service: camera.snapshot
    data_template:
      entity_id: "camera.{{ trigger.entity_id.split('.')[1].split('_')[0] }}_cleaning_map"
      filename: "/home/homeassistant/.homeassistant/www/{{ trigger.entity_id.split('.')[1].split('_')[0] }}_cleaning_map_latest.jpg"

################################################################################
# network_away_mode resume all network services that consume large amount of
# bandwidth
################################################################################
- id: network_away_mode
  alias: 'Network Away Mode'
  initial_state: 'on'
  trigger:
    - platform: zone
      entity_id: person.cearah
      event: leave
      zone: zone.home
    - platform: zone
      entity_id: person.sarah
      event: leave
      zone: zone.home
    - platform: time
      at: '00:00:00'
  condition:
    condition: or
    conditions:
      - condition: template
        value_template: '{{
          states.person.cearah.state != "home" and
          states.person.sarah.state != "home"}}'
      - condition: time
        before: '08:00:00'
  action:
    - service: rest_command.nzbget
      data:
        method: resumedownload
    - service: rest_command.aria2
      data:
        method: aria2.unpauseAll
        token: !secret aria2_token

################################################################################
# network_home_mode pauses all network services that consume large amount of
# bandwidth
################################################################################
- id: network_home_mode
  alias: 'Network Home Mode'
  initial_state: 'on'
  trigger:
    - platform: zone
      entity_id: person.cearah
      event: enter
      zone: zone.home
    - platform: zone
      entity_id: person.sarah
      event: enter
      zone: zone.home
  condition:
    condition: or
    conditions:
      - condition: template
        value_template: '{{
          states.person.cearah.state == "home" or
          states.person.sarah.state == "home"}}'
      - condition: time
        after: '08:00:00'
  action:
    - service: rest_command.nzbget
      data:
        method: pausedownload
    - service: rest_command.aria2
      data:
        method: aria2.pauseAll
        token: !secret aria2_token

################################################################################
# Sonos
################################################################################
- id: sonos_get
  alias: 'Sonos Get'
  initial_state: 'on'
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: media_player.sonos_familyroom
  action:
    - service_template: "homeassistant.turn_{{ 'on' if is_state_attr('media_player.sonos_familyroom', 'speech_enhance', true) else 'off' }}"
      data:
        entity_id: input_boolean.sonos_familyroom_speech_enhance
    - service_template: "homeassistant.turn_{{ 'on' if is_state_attr('media_player.sonos_familyroom', 'night_sound', true) else 'off' }}"
      data:
        entity_id: input_boolean.sonos_familyroom_night_sound
    - service: "input_select.select_option"
      data_template:
        entity_id: input_select.sonos_familyroom_source
        option: "{{ 'TV' if is_state_attr('media_player.sonos_familyroom', 'source', 'TV') else 'None' }}"

- id: sonos_set
  alias: 'Sonos Set'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
        - input_boolean.sonos_familyroom_night_sound
        - input_boolean.sonos_familyroom_speech_enhance
  condition:
    - condition: template
      value_template: >
        {%- if states.automation.sonos_set.attributes.last_triggered -%}
          {{ (as_timestamp(now()) - as_timestamp(states.automation.sonos_set.attributes.last_triggered)) > 2 }}
        {%- else -%}
          true
        {%- endif -%}
    - condition: template
      value_template: '{{
        ( is_state_attr("media_player.sonos_familyroom", "night_sound", true) != is_state("input_boolean.sonos_familyroom_night_sound", "on")) or
        ( is_state_attr("media_player.sonos_familyroom", "speech_enhance", true) != is_state("input_boolean.sonos_familyroom_speech_enhance", "on")) }}'
  action:
    - delay: 00:00:01
    - service: media_player.sonos_set_option
      data_template:
        entity_id: "media_player.sonos_familyroom"
        night_sound: >
          {{ states('input_boolean.sonos_familyroom_night_sound') == "on" }}
        speech_enhance: >
          {{ states('input_boolean.sonos_familyroom_speech_enhance') == "on" }}
